<html>
  <head>
    <link rel="stylesheet" type="text/css" href="style.css"/>
    <script src="matter.min.js"></script>
    <script src="js/Game.js"></script>
    <script src="js/Player.js"></script>
    <script src="js/Renderer.js"></script>
  </head>
  <body>
    <script>

    var Engine = Matter.Engine,
        Render = Matter.Render,
        World = Matter.World,
        Bodies = Matter.Bodies,
        Body = Matter.Body,
        Events = Matter.Events,
        Runner = Matter.Runner,
        Composite = Matter.Composite,
        Vector = Matter.Vector;

    var engine = Engine.create();
    engine.world.gravity.y = 0;
    Engine.run(engine);

    var game = new Game(1000, 1000);
    game.addPlayer(100, 500, "#2467cc");
    game.addPlayer(900, 500, "#d32626", Math.PI);
    game.addPlanet(500, 500, 200);

    // var game = new Game(1800, 1800);
    // game.addPlanet(600, 900, 280);
    // game.addPlanet(1100, 500, 200);
    // game.addPlanet(800, 1500, 150);
    // //game.addPlanet(700, 100, 140);
    // game.addPlayer(200, 1500, "#2467cc", Math.PI*-1/3);
    // game.addPlayer(1500, 1600, "#d32626", Math.PI*-2/3);
    // game.addPlayer(900, 200, "#29a909", Math.PI/2);

    document.addEventListener("wheel", function(e){
      if(e.deltaY < 0) renderer.zoomIn();
      if(e.deltaY > 0) renderer.zoomOut();
    });

    var startX = 0;
    var startY = 0;
    document.addEventListener("mousedown", function(e){
      startX = e.clientX;
      startY = e.clientY;
      document.addEventListener("mousemove", drag);
    });

    function drag(e){
      renderer.offsetX += e.clientX-startX;
      renderer.offsetY += e.clientY-startY;

      startX = e.clientX;
      startY = e.clientY;
    }

    window.addEventListener("resize", function(){
      renderer.resize();
    });

    document.addEventListener("mouseup", function(){
      document.removeEventListener("mousemove", drag);
    });

    document.body.onkeydown = function(e){
      if(e.key == "ArrowLeft"){
        Body.rotate(game.currentPlayer.body, -Math.PI/30);
      }
      if(e.key == "ArrowRight"){
        Body.rotate(game.currentPlayer.body, Math.PI/30);
      }
      if(e.key == "ArrowUp"){
        game.increasePower();
      }
      if(e.key == "ArrowDown"){
        game.decreasePower();
      }
      if(e.keyCode == 32){
        game.addBullet();
      }
    }

    Events.on(engine, "beforeUpdate", function(){
      if(game.bullet){
        var bullet = game.bullet;
        for(var planet of game.planets){
          var r = Vector.sub(planet.position, bullet.position);
          var mag = Vector.magnitude(r);
          var norm = Vector.normalise(r);
          var force = Vector.mult(norm, planet.circleRadius*0.001/mag);
          Body.applyForce(bullet, bullet.position, force);
        }

        game.thinkTime = 0;
        game.bulletTime++;
        if(game.bulletProgress > 1){
          game.endTurn();
        }
      } else {
        game.bulletTime = 0;
        game.thinkTime++;
        if(game.thinkProgress > 1){
          game.endTurn();
        }
      }
    });

    Events.on(engine, "collisionStart", function(e){
      // Check if collision was with a player
      var pair = e.pairs[0];
      var body;
      var bullet;
      if(pair.bodyA.label == "player" && pair.bodyB.label == "bullet"){
        body = pair.bodyA;
        bullet = pair.bodyB;
      }
      else if(pair.bodyB.label == "player" && pair.bodyA.label == "bullet"){
        body = pair.bodyB;
        bullet = pair.bodyA;
      }
      else return;

      // Find the player hit, and decrease lives
      for(var player of game.players){
        if(player.body.id == body.id){
          player.lives--;
          break;
        }
      }

      // Remove bullet from game
      game.endTurn();
    });

    var renderer = new Renderer();
    renderer.init();
    renderer.start();

    </script>
  </body>
</html>
